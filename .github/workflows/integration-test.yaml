name: Integration test

permissions: {}

on:
  pull_request:
  merge_group:

jobs:
  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          persist-credentials: false

      - name: Set up SAM CLI
        uses: aws-actions/setup-sam@c71dd89d980e49367c70391e8ada4353f52f2800
        with:
          use-installer: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444
        with:
          node-version-file: .nvmrc

      - name: Install dependencies
        run: npm ci

      - name: Configure frontend environment
        run: |
          cd solutions/frontend
          touch .env.integration-tests
          echo "ENVIRONMENT=local" >> .env.integration-tests
          echo "NODE_ENV=production" >> .env.integration-tests
          echo "USE_LOCALSTACK=1" >> .env.integration-tests
          echo "SESSIONS_SIGNER=localsessionsignerwhichmustbeatleast32chars  # pragma: allowlist secret" >> .env.integration-tests
          echo "SESSIONS_TABLE_NAME=components-main-SessionStore" >> .env.integration-tests
          echo "ROOT_COOKIE_DOMAIN=localhost" >> .env.integration-tests

      - name: Configure stubs environment
        run: |
          cd solutions/stubs
          touch .env.integration-tests
          echo "ENVIRONMENT=local" >> .env.integration-tests
          echo "NODE_ENV=production" >> .env.integration-tests
          echo "USE_LOCALSTACK=1" >> .env.integration-tests
          echo "MOCK_CLIENT_EC_PRIVATE_KEY_SSM_NAME=/components-mocks/MockClientEcPrivateKey  # pragma: allowlist secret" >> .env.integration-tests
          echo "MOCK_CLIENT_EC_PUBLIC_KEY_SSM_NAME=/components-mocks/MockClientEcPublicKey  # pragma: allowlist secret" >> .env.integration-tests
          echo "JAR_RSA_ENCRYPTION_KEY_ALIAS=alias/components-core-JARRSAEncryptionKey  # pragma: allowlist secret" >> .env.integration-tests

      - name: Configure API environment
        run: |
          cd solutions/api
          touch env.integration-tests.json
          echo "{
            "NODE_OPTIONS": "--enable-source-maps",
            "ENVIRONMENT": "local",          
            "NODE_ENV": "production",
            "USE_LOCALSTACK": "1"
          }" >> env.integration-tests.json

      - name: Install integration tests dependencies
        run: cd solutions/integration-tests && npm ci

      - name: Run integration tests
        run: |
          cd solutions/integration-tests
          touch .env
          echo "PRE_OR_POST_DEPLOY=pre" >> .env
          echo "PW_TEST_CONNECT_WS_ENDPOINT=ws://127.0.0.1:3000/" >> .env
          npm run test
