AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Description: >-
  Core Account Management stack.

Parameters:
  Environment:
    Type: String
    Description: The name of the environment to deploy to
    AllowedValues:
      - dev
      - build
      - staging
      - integration
      - production
    Default: "dev"
  CodeSigningConfigArn:
    Type: String
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
    Default: "none"
  PermissionsBoundary:
    Type: String
    Description: >
      The ARN of the permissions boundary to apply to any role created by the template, provided by the deployment pipeline
    Default: "none"
  VpcStackName:
    Type: String
    Description: >
      The name of the stack that defines the VPC in which resources will be located, provided by the deployment pipeline

Conditions:
  UseCodeSigning:
    Fn::Not:
      - Fn::Equals:
          - !Ref CodeSigningConfigArn
          - "none"
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"

Mappings:
  EnvConfig:
    dev:
      LambdaLogLevel: DEBUG
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
    build:
      LambdaLogLevel: INFO
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
    staging:
      LambdaLogLevel: INFO
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
    integration:
      LambdaLogLevel: INFO
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
    production:
      LambdaLogLevel: INFO
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables #pragma: allowlist secret

Globals:
  Function:
    Tracing: Active
    KmsKeyArn: !GetAtt LambdaEnvironmentVariableEncryptionKey.Arn
    Layers:
      - "arn:aws:lambda:eu-west-2:216552277552:layer:Dynatrace_OneAgent_1_323_2_20250822-051314_with_collector_nodejs:1"
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    VpcConfig:
      SubnetIds:
        - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdA
        - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdB
        - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdC
      SecurityGroupIds:
        - Fn::ImportValue: !Sub ${VpcStackName}-AWSServicesEndpointSecurityGroupId
    Timeout: 15
    MemorySize: 128
    Architectures:
      - arm64
    Runtime: nodejs24.x
    CodeUri: ../../
    Environment:
      Variables:
        NODE_OPTIONS: "--enable-source-maps"
        NODE_ENV: "production"
        POWERTOOLS_LOG_LEVEL:
          !FindInMap [EnvConfig, !Ref Environment, LambdaLogLevel]
        POWERTOOLS_SERVICE_NAME: !Ref AWS::StackName
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        AWS_XRAY_CONTEXT_MISSING: IGNORE_ERROR
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_CONNECTION_BASE_URL: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_CLUSTER_ID: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_TENANT: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_LOGGING_NODEJS_FLAGS: Exporter=true,LambdaSensor=false
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: true
        DT_OPEN_TELEMETRY_ALLOW_EXPLICIT_PARENT: true

Resources:
  DynamoDbSSEKey:
    Type: AWS::KMS::Key
    Properties:
      Description: AWS KMS key for encrypting the data stored within DynamoDB tables
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: "dynamodb.amazonaws.com"
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:DescribeKey"
              - "kms:CreateGrant"
            Resource: "*"
            Condition:
              ArnEquals:
                aws:SourceArn: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/*"
          - Effect: Allow
            Principal:
              Service: "lambda.amazonaws.com"
            Action:
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: "*"
            Condition:
              ArnEquals:
                aws:SourceArn: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-DynamoDbSSEKey"

  DynamoDbSSEKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-DynamoDbSSEKey"
      TargetKeyId: !GetAtt DynamoDbSSEKey.Arn

  CloudWatchEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: AWS KMS key for encrypting CloudWatch logs
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-CloudWatchEncryptionKey"

  CloudWatchEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-CloudWatchEncryptionKey"
      TargetKeyId: !GetAtt CloudWatchEncryptionKey.Arn

  LambdaEnvironmentVariableEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "KMS key used to encrypt lambda environment variables"
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: "Allow"
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:Decrypt"
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn": !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-LambdaEnvironmentVariableEncryptionKey"

  LambdaEnvironmentVariableEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-LambdaEnvironmentVariableEncryptionKey"
      TargetKeyId: !GetAtt LambdaEnvironmentVariableEncryptionKey.Arn

  JARRSAEncryptionKey:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::KMS::Key
    Properties:
      Description: "RSA KMS key pair used to encrypt and decrypt JARs"
      KeySpec: RSA_2048
      KeyUsage: ENCRYPT_DECRYPT
      Origin: AWS_KMS
      Enabled: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: "Allow"
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:Decrypt"
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn":
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:components-api-AuthorizeLambda*"
          - Effect: "Allow"
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:ListAliases"
              - "kms:GetPublicKey"
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn":
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:components-mocks-StubsLambda*"
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-JARRSAEncryptionKey"

  JARRSAEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-JARRSAEncryptionKey"
      TargetKeyId: !GetAtt JARRSAEncryptionKey.Arn

  JWTSigningKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "JWT Signing Key"
      KeySpec: ECC_NIST_P256
      KeyUsage: SIGN_VERIFY
      Origin: AWS_KMS
      Enabled: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: "Allow"
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:Sign"
              - "kms:Verify"
              - "kms:DescribeKey"
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn":
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:components-api-*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-JWTSigningKey"

  JWTSigningKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-JWTSigningKey"
      TargetKeyId: !GetAtt JWTSigningKey.Arn

  S3SSEKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for encrypting JWKSStore bucket
      KeyUsage: ENCRYPT_DECRYPT
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: "*"
            Condition:
              StringEquals:
                kms:ViaService: !Sub "s3.${AWS::Region}.amazonaws.com"
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - kms:GenerateDataKey
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn":
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}*"

  S3SSEKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-S3SSEKey"
      TargetKeyId: !GetAtt S3SSEKey.Arn

  JWKSStoreBucket:
    Type: AWS::S3::Bucket
    DependsOn: AccessLogsBucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-${Environment}-jwks-store"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Sub "${AWS::StackName}-${Environment}-access-logs"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref S3SSEKey

  JWKSStoreBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref JWKSStoreBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Deny
            Principal: "*"
            Action: s3:*
            Resource:
              - !Sub "arn:aws:s3:::${JWKSStoreBucket}"
              - !Sub "arn:aws:s3:::${JWKSStoreBucket}/*"
            Condition:
              Bool:
                aws:SecureTransport: false
              NumericLessThan:
                s3:TlsVersion: "1.2"
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Resource: !Sub "arn:aws:s3:::${JWKSStoreBucket}/*"
            Action:
              - s3:PutObject
          - Effect: Allow
            Resource: !Sub "arn:aws:s3:::${JWKSStoreBucket}/*"
            Principal:
              Service: apigateway.amazonaws.com
            Action:
              - s3:GetObject

  AccessLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-${Environment}-access-logs"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref S3SSEKey

  AccessLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AccessLogsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: EnforceHTTPSOnly
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "${AccessLogsBucket.Arn}"
              - !Sub "${AccessLogsBucket.Arn}/*"
            Condition:
              Bool:
                aws:SecureTransport: false
              NumericLessThan:
                s3:TlsVersion: "1.2"
          - Sid: AllowS3LoggingService
            Effect: Allow
            Principal:
              Service: "logging.s3.amazonaws.com"
            Action: "s3:PutObject"
            Resource: !Sub "${AccessLogsBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId

  JwksGeneratorLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Creates a JWKS doc and stores it into a S3 Bucket"
      Handler: jwks-creator.handler
      DeploymentPreference:
        Enabled: false
      LoggingConfig:
        LogGroup: !Ref JwksGeneratorLambdaLogGroup
      Environment:
        Variables:
          BUCKET_NAME: !Ref JWKSStoreBucket
          JAR_RSA_ENCRYPTION_KEY_ALIAS: !Ref JARRSAEncryptionKeyAlias
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - Statement:
            - Effect: Allow
              Action:
                - kms:GetPublicKey
                - kms:DescribeKey
              Resource: !GetAtt JARRSAEncryptionKey.Arn
            - Effect: Allow
              Action:
                - kms:GenerateDataKey
              Resource: !GetAtt S3SSEKey.Arn
            - Effect: Allow
              Action:
                - s3:PutObject
              Resource: !Sub "${JWKSStoreBucket.Arn}/*"
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: !GetAtt JwksGeneratorLambdaLogGroup.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Format: esm
        OutExtension:
          - .js=.mjs
        Target: es2024
        Sourcemap: true
        EntryPoints:
          - solutions/core/src/lambda/jwks-creator.ts
        Banner:
          - js=import { createRequire } from 'module'; const require = createRequire(import.meta.url); # Required in order to use AWS Lambda Powertools

  JwksGeneratorLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/JwksGeneratorLambda"
      RetentionInDays: 30
      KmsKeyId: !GetAtt CloudWatchEncryptionKey.Arn

  JwksGeneratorLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref JwksGeneratorLambda
      Action: lambda:InvokeFunction
      Principal: cloudformation.amazonaws.com

  JwksGeneratorTrigger:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt JwksGeneratorLambda.Arn
      ForceUpdate: !Ref JwksGeneratorLambda

  ApiSessionsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub ${AWS::StackName}-ApiSessions
      AttributeDefinitions:
        - AttributeName: "id"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "id"
          KeyType: "HASH"
      BillingMode: PAY_PER_REQUEST
      ContributorInsightsSpecification:
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false
      TimeToLiveSpecification:
        AttributeName: "expires"
        Enabled: true
      SSESpecification:
        KMSMasterKeyId: !GetAtt DynamoDbSSEKey.Arn
        SSEEnabled: true
        SSEType: KMS
      TableClass: STANDARD
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-api_sessions"

  AuthCodeTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub ${AWS::StackName}-AuthCode
      AttributeDefinitions:
        - AttributeName: "code"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "code"
          KeyType: "HASH"
      BillingMode: PAY_PER_REQUEST
      ContributorInsightsSpecification:
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false
      TimeToLiveSpecification:
        AttributeName: "expires"
        Enabled: true
      SSESpecification:
        KMSMasterKeyId: !GetAtt DynamoDbSSEKey.Arn
        SSEEnabled: true
        SSEType: KMS
      TableClass: STANDARD
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-auth_code"

  JourneyOutcomeTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub ${AWS::StackName}-JourneyOutcome
      AttributeDefinitions:
        - AttributeName: outcome_id
          AttributeType: S
      KeySchema:
        - AttributeName: outcome_id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      ContributorInsightsSpecification:
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false
      TimeToLiveSpecification:
        AttributeName: "expires"
        Enabled: true
      SSESpecification:
        KMSMasterKeyId: !GetAtt DynamoDbSSEKey.Arn
        SSEEnabled: true
        SSEType: KMS
      TableClass: STANDARD
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-journey_outcome"

  JourneyOutcomeTableArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JourneyOutcomeTableArn"
      Type: String
      Value: !GetAtt JourneyOutcomeTable.Arn
      Description: ARN of the journey outcome table

  JourneyOutcomeTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JourneyOutcomeTableName"
      Type: String
      Value: !Ref JourneyOutcomeTable
      Description: Name of the journey outcome table

  ApiSessionsTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/ApiSessionsTableName"
      Type: String
      Value: !Ref ApiSessionsTable
      Description: Name of the API sessions table

  ApiSessionsTableArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/ApiSessionsTableArn"
      Type: String
      Value: !GetAtt ApiSessionsTable.Arn
      Description: ARN of the API sessions table

  AuthCodeTableArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/AuthCodeTableArn"
      Type: String
      Value: !GetAtt AuthCodeTable.Arn
      Description: ARN of the auth code table

  AuthCodeTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/AuthCodeTableName"
      Type: String
      Value: !Ref AuthCodeTable
      Description: Name of the auth code table

  JWKSStoreBucketNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JWKSStoreBucketName"
      Type: String
      Value: !Ref JWKSStoreBucket
      Description: Name of the S3 bucket that stores the JWKS document

  S3SSEKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/S3SSEKeyArn"
      Type: String
      Value: !GetAtt S3SSEKey.Arn
      Description: ARN of the KMS key used for encryption of S3 buckets

  DynamoDbSSEKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/DynamoDbSSEKeyArn"
      Type: String
      Value: !GetAtt DynamoDbSSEKey.Arn
      Description: ARN of the KMS key used to encrypt DynamoDB tables

  LambdaEnvironmentVariableEncryptionKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/LambdaEnvironmentVariableEncryptionKeyArn"
      Type: String
      Value: !GetAtt LambdaEnvironmentVariableEncryptionKey.Arn
      Description: ARN of the KMS key used to encrypt lambda environment variables

  CloudWatchEncryptionKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/CloudWatchEncryptionKeyArn"
      Type: String
      Value: !GetAtt CloudWatchEncryptionKey.Arn
      Description: ARN of the KMS key used to encrypt CloudWatch logs

  JARRSAEncryptionKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JARRSAEncryptionKeyArn"
      Type: String
      Value: !GetAtt JARRSAEncryptionKey.Arn
      Description: ARN of the JAR RSA encryption KMS key

  JARRSAEncryptionKeyAliasParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JARRSAEncryptionKeyAlias"
      Type: String
      Value: !Ref JARRSAEncryptionKeyAlias
      Description: Alias of the JAR RSA encryption KMS key

  JWTSigningKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JWTSigningKeyArn"
      Type: String
      Value: !GetAtt JWTSigningKey.Arn
      Description: ARN of the JWT Signing KMS key

  JWTSigningKeyAliasParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JWTSigningKeyAlias"
      Type: String
      Value: !Ref JWTSigningKeyAlias
      Description: Alias of the JWT Signing KMS key
