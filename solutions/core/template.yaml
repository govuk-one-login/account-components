AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Description: >-
  Core Account Management stack.

Parameters:
  Environment:
    Type: String
    Description: The name of the environment to deploy to
    AllowedValues:
      - dev
      - build
      - staging
      - integration
      - production
    Default: "dev"
  CodeSigningConfigArn:
    Type: String
    Description: >
      The ARN of the Code Signing Config to use, provided by the deployment pipeline
    Default: "none"
  PermissionsBoundary:
    Type: String
    Description: >
      The ARN of the permissions boundary to apply to any role created by the template, provided by the deployment pipeline
    Default: "none"
  VpcStackName:
    Type: String
    Description: >
      The name of the stack that defines the VPC in which resources will be located, provided by the deployment pipeline
  AlertingStackName:
    Type: String
    Description: The name of the alerting stack that contains SNS topics for alarms
    Default: "component-alarms"
  LambdaDeploymentPreference:
    Description: Specifies the configuration to enable gradual Lambda deployments. It can be used to set deployment type and also allows skipping canary deployment by setting to 'AllAtOnce'
    Type: String
    Default: "Canary10Percent10Minutes"
    AllowedValues:
      - AllAtOnce
      - Canary10Percent5Minutes
      - Canary10Percent10Minutes
      - Canary10Percent15Minutes
      - Canary10Percent30Minutes

Conditions:
  UseCodeSigning:
    Fn::Not:
      - Fn::Equals:
          - !Ref CodeSigningConfigArn
          - "none"
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"
  CanariesEnabled: !Equals
    - !FindInMap [EnvConfig, !Ref Environment, UseCanary]
    - true

Mappings:
  EnvConfig:
    dev:
      UseCanary: false
      LambdaLogLevel: DEBUG
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
      notifyTemplateIds: |
        {
          "CREATE_PASSKEY": "TODO"
        }
    build:
      UseCanary: false
      LambdaLogLevel: INFO
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
      notifyTemplateIds: |
        {
          "CREATE_PASSKEY": "TODO"
        }
    staging:
      UseCanary: true
      LambdaLogLevel: INFO
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
      notifyTemplateIds: |
        {
          "CREATE_PASSKEY": "TODO"
        }
    integration:
      UseCanary: true
      LambdaLogLevel: INFO
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceNonProductionVariables #pragma: allowlist secret
      notifyTemplateIds: |
        {
          "CREATE_PASSKEY": "TODO"
        }
    production:
      UseCanary: true
      LambdaLogLevel: INFO
      dynatraceSecretArn: arn:aws:secretsmanager:eu-west-2:216552277552:secret:DynatraceProductionVariables #pragma: allowlist secret
      notifyTemplateIds: |
        {
          "CREATE_PASSKEY": "TODO"
        }

Globals:
  Function:
    DeploymentPreference:
      Type: !If
        - CanariesEnabled
        - !Ref LambdaDeploymentPreference
        - AllAtOnce
      Alarms: []
      Role: !GetAtt CodeDeployServiceRole.Arn
    Tracing: Active
    AutoPublishAlias: live
    KmsKeyArn: !GetAtt LambdaEnvironmentVariableEncryptionKey.Arn
    Layers:
      - "arn:aws:lambda:eu-west-2:216552277552:layer:Dynatrace_OneAgent_1_323_2_20250822-051314_with_collector_nodejs:1"
    CodeSigningConfigArn: !If
      - UseCodeSigning
      - !Ref CodeSigningConfigArn
      - !Ref AWS::NoValue
    PermissionsBoundary: !If
      - UsePermissionsBoundary
      - !Ref PermissionsBoundary
      - !Ref AWS::NoValue
    VpcConfig:
      SecurityGroupIds:
        - Fn::ImportValue: !Sub ${VpcStackName}-AWSServicesEndpointSecurityGroupId
    Timeout: 15
    MemorySize: 128
    Architectures:
      - arm64
    Runtime: nodejs24.x
    CodeUri: ../../
    Environment:
      Variables:
        NODE_OPTIONS: "--enable-source-maps"
        NODE_ENV: "production"
        POWERTOOLS_LOG_LEVEL:
          !FindInMap [EnvConfig, !Ref Environment, LambdaLogLevel]
        POWERTOOLS_SERVICE_NAME: !Ref AWS::StackName
        AWS_LAMBDA_EXEC_WRAPPER: /opt/dynatrace
        AWS_XRAY_CONTEXT_MISSING: IGNORE_ERROR
        DT_CONNECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_AUTH_TOKEN}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_CONNECTION_BASE_URL: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CONNECTION_BASE_URL}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_CLUSTER_ID: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_CLUSTER_ID}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_LOG_COLLECTION_AUTH_TOKEN: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_LOG_COLLECTION_AUTH_TOKEN}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_TENANT: !Sub
          - "{{resolve:secretsmanager:${SecretArn}:SecretString:DT_TENANT}}" #pragma: allowlist secret
          - SecretArn:
              !FindInMap [EnvConfig, !Ref Environment, dynatraceSecretArn]
        DT_LOGGING_NODEJS_FLAGS: Exporter=true,LambdaSensor=false
        DT_OPEN_TELEMETRY_ENABLE_INTEGRATION: true
        DT_OPEN_TELEMETRY_ALLOW_EXPLICIT_PARENT: true

Resources:
  CodeDeployServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - codedeploy.amazonaws.com
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSCodeDeployRoleForLambda
      PermissionsBoundary:
        !If [
          UsePermissionsBoundary,
          !Ref PermissionsBoundary,
          !Ref AWS::NoValue,
        ]

  DynamoDbSSEKey:
    Type: AWS::KMS::Key
    Properties:
      Description: AWS KMS key for encrypting the data stored within DynamoDB tables
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - "kms:*"
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: "dynamodb.amazonaws.com"
            Action:
              - "kms:Encrypt"
              - "kms:Decrypt"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:DescribeKey"
              - "kms:CreateGrant"
            Resource: "*"
            Condition:
              ArnEquals:
                aws:SourceArn: !Sub "arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/*"
          - Effect: Allow
            Principal:
              Service: "lambda.amazonaws.com"
            Action:
              - "kms:Decrypt"
              - "kms:GenerateDataKey"
            Resource: "*"
            Condition:
              ArnEquals:
                aws:SourceArn: !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-DynamoDbSSEKey"

  DynamoDbSSEKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-DynamoDbSSEKey"
      TargetKeyId: !GetAtt DynamoDbSSEKey.Arn

  CloudWatchEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: AWS KMS key for encrypting CloudWatch logs
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn": !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-CloudWatchEncryptionKey"

  CloudWatchEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-CloudWatchEncryptionKey"
      TargetKeyId: !GetAtt CloudWatchEncryptionKey.Arn

  LambdaEnvironmentVariableEncryptionKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "KMS key used to encrypt lambda environment variables"
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: "Allow"
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:Decrypt"
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn": !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-LambdaEnvironmentVariableEncryptionKey"

  LambdaEnvironmentVariableEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-LambdaEnvironmentVariableEncryptionKey"
      TargetKeyId: !GetAtt LambdaEnvironmentVariableEncryptionKey.Arn

  JARRSAEncryptionKey:
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Type: AWS::KMS::Key
    Properties:
      Description: "RSA KMS key pair used to encrypt and decrypt JARs"
      KeySpec: RSA_2048
      KeyUsage: ENCRYPT_DECRYPT
      Origin: AWS_KMS
      Enabled: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: "Allow"
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:Decrypt"
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn":
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:components-api-AuthorizeLambda*"
          - Effect: "Allow"
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:ListAliases"
              - "kms:GetPublicKey"
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn":
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:components-mocks-StubsLambda*"
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-JARRSAEncryptionKey"

  JARRSAEncryptionKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-JARRSAEncryptionKey"
      TargetKeyId: !GetAtt JARRSAEncryptionKey.Arn

  JWTSigningKey:
    Type: AWS::KMS::Key
    Properties:
      Description: "JWT Signing Key"
      KeySpec: ECC_NIST_P256
      KeyUsage: SIGN_VERIFY
      Origin: AWS_KMS
      Enabled: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: "Allow"
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - "kms:Sign"
              - "kms:Verify"
              - "kms:DescribeKey"
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn":
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:components-api-*"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-JWTSigningKey"

  JWTSigningKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-JWTSigningKey"
      TargetKeyId: !GetAtt JWTSigningKey.Arn

  S3SSEKey:
    Type: AWS::KMS::Key
    Properties:
      Description: KMS key for encrypting JWKSStore bucket
      KeyUsage: ENCRYPT_DECRYPT
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: "*"
            Condition:
              StringEquals:
                kms:ViaService: !Sub "s3.${AWS::Region}.amazonaws.com"
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action:
              - kms:GenerateDataKey
            Resource: "*"
            Condition:
              ArnLike:
                "aws:SourceArn":
                  - !Sub "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:${AWS::StackName}*"

  S3SSEKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-S3SSEKey"
      TargetKeyId: !GetAtt S3SSEKey.Arn

  JWKSStoreBucket:
    Type: AWS::S3::Bucket
    DependsOn: AccessLogsBucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-${Environment}-jwks-store"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      LoggingConfiguration:
        DestinationBucketName: !Sub "${AWS::StackName}-${Environment}-access-logs"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref S3SSEKey

  JWKSStoreBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref JWKSStoreBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Deny
            Principal: "*"
            Action: s3:*
            Resource:
              - !Sub "arn:aws:s3:::${JWKSStoreBucket}"
              - !Sub "arn:aws:s3:::${JWKSStoreBucket}/*"
            Condition:
              Bool:
                aws:SecureTransport: false
              NumericLessThan:
                s3:TlsVersion: "1.2"
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Resource: !Sub "arn:aws:s3:::${JWKSStoreBucket}/*"
            Action:
              - s3:PutObject
          - Effect: Allow
            Resource: !Sub "arn:aws:s3:::${JWKSStoreBucket}/*"
            Principal:
              Service: apigateway.amazonaws.com
            Action:
              - s3:GetObject

  AccessLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub "${AWS::StackName}-${Environment}-access-logs"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref S3SSEKey

  AccessLogBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AccessLogsBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: EnforceHTTPSOnly
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub "${AccessLogsBucket.Arn}"
              - !Sub "${AccessLogsBucket.Arn}/*"
            Condition:
              Bool:
                aws:SecureTransport: false
              NumericLessThan:
                s3:TlsVersion: "1.2"
          - Sid: AllowS3LoggingService
            Effect: Allow
            Principal:
              Service: "logging.s3.amazonaws.com"
            Action: "s3:PutObject"
            Resource: !Sub "${AccessLogsBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
            Condition:
              StringEquals:
                aws:SourceAccount: !Ref AWS::AccountId

  JwksGeneratorLambda:
    Type: AWS::Serverless::Function
    Properties:
      Description: "Creates a JWKS doc and stores it into a S3 Bucket"
      Handler: jwks-creator.handler
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-PrivateSubnetIdC
      DeploymentPreference:
        Enabled: false
      LoggingConfig:
        LogGroup: !Ref JwksGeneratorLambdaLogGroup
      Environment:
        Variables:
          BUCKET_NAME: !Ref JWKSStoreBucket
          JAR_RSA_ENCRYPTION_KEY_ALIAS: !Ref JARRSAEncryptionKeyAlias
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - Statement:
            - Effect: Allow
              Action:
                - kms:GetPublicKey
                - kms:DescribeKey
              Resource: !GetAtt JARRSAEncryptionKey.Arn
            - Effect: Allow
              Action:
                - kms:GenerateDataKey
              Resource: !GetAtt S3SSEKey.Arn
            - Effect: Allow
              Action:
                - s3:PutObject
              Resource: !Sub "${JWKSStoreBucket.Arn}/*"
            - Effect: Allow
              Action:
                - logs:CreateLogGroup
                - logs:CreateLogStream
                - logs:PutLogEvents
              Resource: !GetAtt JwksGeneratorLambdaLogGroup.Arn
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Format: esm
        OutExtension:
          - .js=.mjs
        Target: es2024
        Sourcemap: true
        EntryPoints:
          - solutions/core/src/lambda/jwks-creator.ts
        Banner:
          - js=import { createRequire } from 'module'; const require = createRequire(import.meta.url); # Required in order to use AWS Lambda Powertools

  JwksGeneratorLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/JwksGeneratorLambda"
      RetentionInDays: 30
      KmsKeyId: !GetAtt CloudWatchEncryptionKey.Arn

  JwksGeneratorLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref JwksGeneratorLambda
      Action: lambda:InvokeFunction
      Principal: cloudformation.amazonaws.com

  JwksGeneratorTrigger:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt JwksGeneratorLambda.Arn
      ForceUpdate: !Ref JwksGeneratorLambda

  AuthCodeTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub ${AWS::StackName}-AuthCode
      AttributeDefinitions:
        - AttributeName: "code"
          AttributeType: "S"
      KeySchema:
        - AttributeName: "code"
          KeyType: "HASH"
      BillingMode: PAY_PER_REQUEST
      ContributorInsightsSpecification:
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false
      TimeToLiveSpecification:
        AttributeName: "expires"
        Enabled: true
      SSESpecification:
        KMSMasterKeyId: !GetAtt DynamoDbSSEKey.Arn
        SSEEnabled: true
        SSEType: KMS
      TableClass: STANDARD
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-auth_code"

  JourneyOutcomeTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub ${AWS::StackName}-JourneyOutcome
      AttributeDefinitions:
        - AttributeName: outcome_id
          AttributeType: S
      KeySchema:
        - AttributeName: outcome_id
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      ContributorInsightsSpecification:
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false
      TimeToLiveSpecification:
        AttributeName: "expires"
        Enabled: true
      SSESpecification:
        KMSMasterKeyId: !GetAtt DynamoDbSSEKey.Arn
        SSEEnabled: true
        SSEType: KMS
      TableClass: STANDARD
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-journey_outcome"

  ReplayAttackTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      TableName: !Sub ${AWS::StackName}-ReplayAttack
      AttributeDefinitions:
        - AttributeName: nonce
          AttributeType: S
      KeySchema:
        - AttributeName: nonce
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expires
        Enabled: true
      BillingMode: PAY_PER_REQUEST
      ContributorInsightsSpecification:
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: false
      SSESpecification:
        KMSMasterKeyId: !GetAtt DynamoDbSSEKey.Arn
        SSEEnabled: true
        SSEType: KMS
      TableClass: STANDARD
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-replay_attack"

  SecretsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action: "kms:*"
            Resource: "*"

  SecretsKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-SecretsKmsKey"
      TargetKeyId: !GetAtt SecretsKmsKey.Arn

  NotifyAPIKeySecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      KmsKeyId: !Ref SecretsKmsKey
      SecretString: set-me # pragma: allowlist secret

  SqsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
            Action: kms:*
            Resource:
              - "*"

  SqsKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-SqsKmsKey"
      TargetKeyId: !Ref SqsKmsKey

  NotificationsQueue:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      VisibilityTimeout: 20
      KmsMasterKeyId: !GetAtt SqsKmsKey.Arn
      RedriveAllowPolicy:
        redrivePermission: denyAll
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt NotificationsDLQ.Arn
        maxReceiveCount: 5

  NotificationsDLQ:
    Type: AWS::SQS::Queue
    Properties:
      KmsMasterKeyId: !GetAtt SqsKmsKey.Arn
      MessageRetentionPeriod: 1209600

  NotificationsServiceLambda:
    Type: AWS::Serverless::Function
    Properties:
      LoggingConfig:
        LogGroup: !Ref NotificationsServiceLambdaLogGroup
      Events:
        NotificationsQueue:
          Type: SQS
          Properties:
            Queue: !GetAtt NotificationsQueue.Arn
            BatchSize: 10
            FunctionResponseTypes:
              - ReportBatchItemFailures
      Handler: notifications-service.handler
      Runtime: nodejs22.x # as at 2026-02-03 the notifications-node-client library does not work with Node 24 or newer
      VpcConfig:
        SubnetIds:
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdA
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdB
          - Fn::ImportValue: !Sub ${VpcStackName}-ProtectedSubnetIdC
      Environment:
        Variables:
          NOTIFY_API_KEY_SECRET_ARN: !Ref NotifyAPIKeySecret
          NOTIFY_TEMPLATE_IDS:
            !FindInMap [EnvConfig, !Ref Environment, notifyTemplateIds]
      DeploymentPreference:
        Alarms:
          - !Ref NotificationsServiceFunctionSuccessRate
      Policies:
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - Statement:
            - Effect: Allow
              Action:
                - sqs:ReceiveMessage
                - sqs:DeleteMessage
                - sqs:GetQueueAttributes
              Resource: !GetAtt NotificationsQueue.Arn
            - Effect: Allow
              Action:
                - kms:Decrypt
              Resource: !GetAtt SqsKmsKey.Arn
            - Effect: Allow
              Action:
                - "kms:Decrypt"
              Resource:
                - !GetAtt SecretsKmsKey.Arn
            - Effect: Allow
              Action: secretsmanager:GetSecretValue # pragma: allowlist secret
              Resource: !Ref NotifyAPIKeySecret
    Metadata:
      BuildMethod: esbuild
      BuildProperties:
        Minify: true
        Format: esm
        OutExtension:
          - .js=.mjs
        Target: es2022 # as at 2026-02-03 the notifications-node-client library does not work with Node 24 or newer
        Sourcemap: true
        EntryPoints:
          - solutions/core/src/lambda/notifications-service.ts
        Banner:
          - js=import { createRequire } from 'module'; const require = createRequire(import.meta.url); # Required in order to use AWS Lambda Powertools

  NotificationsServiceLambdaLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AWS::StackName}/NotificationsService"
      RetentionInDays: 30
      KmsKeyId: !GetAtt CloudWatchEncryptionKey.Arn

  NotificationsServiceFunctionSuccessRate:
    Type: AWS::CloudWatch::Alarm
    Properties:
      Metrics:
        - Id: errors
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Errors
              Dimensions:
                - Name: FunctionName
                  Value: !Ref NotificationsServiceLambda
            Period: 300
            Stat: Sum
          ReturnData: false
        - Id: invocations
          MetricStat:
            Metric:
              Namespace: AWS/Lambda
              MetricName: Invocations
              Dimensions:
                - Name: FunctionName
                  Value: !Ref NotificationsServiceLambda
            Period: 300
            Stat: Sum
          ReturnData: false
        - Id: successRate
          Expression: "1 - (errors / invocations)"
          Label: "Success Rate"
          ReturnData: true
      Threshold: 0.95
      ComparisonOperator: LessThanThreshold
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      AlarmActions:
        - !Sub "{{resolve:ssm:/${AlertingStackName}/LowSeveritySNSTopicArn}}"

  NotificationsQueueProcessingTooSlow:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Sub "{{resolve:ssm:/${AlertingStackName}/LowSeveritySNSTopicArn}}"
      ComparisonOperator: GreaterThanThreshold
      Threshold: 600
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !GetAtt NotificationsQueue.QueueName
      MetricName: ApproximateAgeOfOldestMessage
      Namespace: AWS/SQS
      Period: 60
      Statistic: Maximum

  NotificationsDLQHasMessages:
    Type: AWS::CloudWatch::Alarm
    Properties:
      ActionsEnabled: true
      AlarmActions:
        - !Sub "{{resolve:ssm:/${AlertingStackName}/LowSeveritySNSTopicArn}}"
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Threshold: 1
      EvaluationPeriods: 1
      TreatMissingData: notBreaching
      Dimensions:
        - Name: QueueName
          Value: !GetAtt NotificationsDLQ.QueueName
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Period: 60
      Statistic: Maximum

  SqsKmsKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/SqsKmsKeyArn"
      Type: String
      Value: !GetAtt SqsKmsKey.Arn
      Description: ARN of the KMS key used to encrypt SQS queues

  NotificationsQueueArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/NotificationsQueueArn"
      Type: String
      Value: !GetAtt NotificationsQueue.Arn
      Description: ARN of the notifications queue

  NotificationsQueueUrlParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/NotificationsQueueUrl"
      Type: String
      Value: !GetAtt NotificationsQueue.QueueUrl
      Description: URL of the notifications queue

  JourneyOutcomeTableArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JourneyOutcomeTableArn"
      Type: String
      Value: !GetAtt JourneyOutcomeTable.Arn
      Description: ARN of the journey outcome table

  JourneyOutcomeTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JourneyOutcomeTableName"
      Type: String
      Value: !Ref JourneyOutcomeTable
      Description: Name of the journey outcome table

  AuthCodeTableArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/AuthCodeTableArn"
      Type: String
      Value: !GetAtt AuthCodeTable.Arn
      Description: ARN of the auth code table

  AuthCodeTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/AuthCodeTableName"
      Type: String
      Value: !Ref AuthCodeTable
      Description: Name of the auth code table

  ReplayAttackTableArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/ReplayAttackTableArn"
      Type: String
      Value: !GetAtt ReplayAttackTable.Arn
      Description: ARN of the replay attack table

  ReplayAttackTableNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/ReplayAttackTableName"
      Type: String
      Value: !Ref ReplayAttackTable
      Description: Name of the replay attack table

  JWKSStoreBucketNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JWKSStoreBucketName"
      Type: String
      Value: !Ref JWKSStoreBucket
      Description: Name of the S3 bucket that stores the JWKS document

  S3SSEKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/S3SSEKeyArn"
      Type: String
      Value: !GetAtt S3SSEKey.Arn
      Description: ARN of the KMS key used for encryption of S3 buckets

  DynamoDbSSEKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/DynamoDbSSEKeyArn"
      Type: String
      Value: !GetAtt DynamoDbSSEKey.Arn
      Description: ARN of the KMS key used to encrypt DynamoDB tables

  LambdaEnvironmentVariableEncryptionKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/LambdaEnvironmentVariableEncryptionKeyArn"
      Type: String
      Value: !GetAtt LambdaEnvironmentVariableEncryptionKey.Arn
      Description: ARN of the KMS key used to encrypt lambda environment variables

  CloudWatchEncryptionKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/CloudWatchEncryptionKeyArn"
      Type: String
      Value: !GetAtt CloudWatchEncryptionKey.Arn
      Description: ARN of the KMS key used to encrypt CloudWatch logs

  JARRSAEncryptionKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JARRSAEncryptionKeyArn"
      Type: String
      Value: !GetAtt JARRSAEncryptionKey.Arn
      Description: ARN of the JAR RSA encryption KMS key

  JARRSAEncryptionKeyAliasParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JARRSAEncryptionKeyAlias"
      Type: String
      Value: !Ref JARRSAEncryptionKeyAlias
      Description: Alias of the JAR RSA encryption KMS key

  JWTSigningKeyArnParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JWTSigningKeyArn"
      Type: String
      Value: !GetAtt JWTSigningKey.Arn
      Description: ARN of the JWT Signing KMS key

  JWTSigningKeyAliasParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/${AWS::StackName}/JWTSigningKeyAlias"
      Type: String
      Value: !Ref JWTSigningKeyAlias
      Description: Alias of the JWT Signing KMS key
