{% extends "templates/layout/base-page.njk" %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/details/macro.njk" import govukDetails %}

{% set pageTitleName = 'journey:create.pageTitle' | translate %}

{% block pageContent %}
  <h1 class="govuk-heading-l">{{ 'journey:create.heading' | translate }}</h1>

  {% set paragraphs = 'journey:create.paragraphs' | translate({ returnObjects: true }) %}

  {% for paragraph in paragraphs %}
    <p class="govuk-body">{{ paragraph }}</p>
  {% endfor %}

  {% set guidanceNoticeParagraphs = 'journey:create.guidanceNoticeParagraphs' | translate({ returnObjects: true }) %}

  {% set guidanceNoticeHtml %}
    {% for paragraph in guidanceNoticeParagraphs %}
      <p class="govuk-body">{{ paragraph }}</p>
    {% endfor %}
  {% endset %}

  {{ govukDetails({
    summaryText: 'journey:create.guidanceNoticeTitle' | translate,
    html: guidanceNoticeHtml
  }) }}

  <form method="post" style="display: none;" id="verifyPasskeyForm">
    <input type="hidden" name="_csrf" value="{{ globals.csrfToken }}">
    <input type="hidden" name="registrationResponse">
  </form>

  {{ govukButton({
    text: 'journey:create.buttonLabel' | translate,
    preventDoubleClick: true,
    id: "registerPasskeyTrigger"
  }) }}

  {% set exitJourneyUrl = globals.buildRedirectToClientRedirectUri(globals.authorizeErrors.userAborted) %}
  <p class="govuk-body"><a href="{{ exitJourneyUrl }}" class="govuk-link govuk-link--no-visited-state">{{ 'journey:create.exitJourneyLinkText' | translate }}</a></p>  
{% endblock %}

{% block scripts %}
<script src="/@simplewebauthn/browser/dist/bundle/index.es5.umd.min.js?{{ globals.simpleWebAuthNStaticHash }}" nonce='{{ cspNonce }}'></script>

<script nonce='{{ cspNonce }}'>
  async function registerPasskey() {
    const registrationOptions = {{ registrationOptions | dump | safe }}
    const registrationResponse = await SimpleWebAuthnBrowser.startRegistration(registrationOptions);
    // TODO better error handling

    const verifyPasskeyForm = document.getElementById('verifyPasskeyForm')
    verifyPasskeyForm.querySelector('input[name="registrationResponse"]').value = JSON.stringify(registrationResponse)
    verifyPasskeyForm.submit()
  }

  document.getElementById('registerPasskeyTrigger').addEventListener('click', registerPasskey);
</script>
{% endblock %}